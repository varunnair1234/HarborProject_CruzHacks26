<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harbor - Small Business Operating System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(to bottom right, #f8fafc, #e0e7ff);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            color: #0A4D68;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 2rem;
            text-align: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0.75rem;
            background: #fafafa;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: #374151;
            background: #f3f4f6;
        }

        .tab-button.active {
            color: #1f2937;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .tab-icon svg {
            width: 100%;
            height: 100%;
            stroke: currentColor;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Common Styles */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 8px;
            padding: 1.5rem;
            color: #c33;
            margin: 2rem 0;
        }

        .error code {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            display: block;
            margin-top: 0.5rem;
        }

        .success-message {
            background: #dcfce7;
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 1.5rem;
            color: #166534;
            margin: 1rem 0;
        }

        /* TouristPulse Styles */
        .outlook-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .outlook-card {
            background: #fef7f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #f5e6d3;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .outlook-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-date-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .card-day {
            font-size: 0.875rem;
            font-weight: 500;
            color: #9ca3af;
        }

        .card-date {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .activity-badge-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .activity-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .activity-badge.high {
            background: #fed7aa;
            color: #9a3412;
        }

        .activity-badge.moderate {
            background: #dbeafe;
            color: #1e40af;
        }

        .activity-badge.low {
            background: #fef3c7;
            color: #92400e;
        }

        .activity-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-icon svg {
            width: 100%;
            height: 100%;
        }

        .activity-progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-progress-bar {
            width: 60px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .activity-progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4b5563, #6b7280);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .activity-percentage {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .card-summary {
            margin: 1rem 0;
            line-height: 1.6;
            color: #4b5563;
            font-size: 0.95rem;
            font-style: italic;
            padding: 0 0.5rem;
        }

        .card-summary::before {
            content: '"';
        }

        .card-summary::after {
            content: '"';
        }

        .key-drivers {
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .key-drivers-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .driver-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .driver-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #86efac;
        }

        .driver-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        /* Module Container Styles */
        .module-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .module-container {
                grid-template-columns: 1fr;
            }
        }

        .form-panel, .results-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .form-panel h3, .results-panel h3 {
            color: #0A4D68;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0A4D68;
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-divider {
            text-align: center;
            margin: 1rem 0;
            color: #9ca3af;
            font-weight: 600;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0A4D68;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #083d54;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* File Input Styling */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            border-color: #0A4D68;
            color: #0A4D68;
        }

        .file-input-label.has-file {
            border-color: #22c55e;
            background: #dcfce7;
            color: #166534;
        }

        /* Results Panel Empty State */
        .results-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .results-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Risk State Badges */
        .risk-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-badge.healthy {
            background: #dcfce7;
            color: #166534;
        }

        .risk-badge.caution {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Impact Card */
        .impact-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .impact-header {
            background: linear-gradient(135deg, #0A4D68, #0e6b8a);
            color: white;
            padding: 1rem 1.5rem;
        }

        .impact-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .impact-body {
            padding: 1.5rem;
        }

        .impact-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 600px) {
            .impact-metrics {
                grid-template-columns: 1fr;
            }
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0A4D68;
        }

        .metric-value.negative {
            color: #dc2626;
        }

        .metric-value.positive {
            color: #16a34a;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .risk-transition {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .risk-arrow {
            font-size: 1.5rem;
            color: #6b7280;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e5e7eb;
        }

        .explanation-section h5 {
            color: #374151;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .explanation-section p {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .concerns-list,
        .recommendations-list,
        .bullets-list {
            margin: 0;
            padding-left: 1.25rem;
        }

        .concerns-list li {
            color: #dc2626;
            margin-bottom: 0.5rem;
        }

        .recommendations-list li {
            color: #0A4D68;
            margin-bottom: 0.5rem;
        }

        .bullets-list li {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        /* Scenarios/History List */
        .history-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e5e7eb;
        }

        .history-section h4 {
            color: #374151;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f3f4f6;
        }

        .history-item .date {
            color: #6b7280;
            font-size: 0.85rem;
        }

        /* Warning Message */
        .warning-message {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            color: #92400e;
        }

        .warning-message a {
            color: #0A4D68;
            font-weight: 600;
        }

        /* Shopline Styles */
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box input {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0A4D68;
        }

        .search-box button {
            padding: 0.875rem 1.5rem;
            background: #0A4D68;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .search-box button:hover {
            background: #083d54;
        }

        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .business-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .business-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .business-card h4 {
            color: #0A4D68;
            margin-bottom: 0.5rem;
        }

        .business-card .category {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .business-card .location {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .business-card .description {
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .business-card .score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #0A4D68);
            border-radius: 4px;
        }

        .score-value {
            font-weight: 600;
            color: #0A4D68;
        }

        .highlights-list {
            margin-top: 0.75rem;
            padding-left: 1rem;
        }

        .highlights-list li {
            color: #16a34a;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header h2 {
            margin: 0;
        }

        .forecast-header {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .forecast-title {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 2rem;
            font-weight: 400;
            color: #374151;
            margin: 0;
            line-height: 1.2;
        }

        .forecast-location {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-left: 0.5rem;
            font-size: 0.95rem;
            color: #9ca3af;
            font-weight: 400;
        }

        .location-icon {
            width: 16px;
            height: 16px;
            color: #9ca3af;
            flex-shrink: 0;
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Analysis Display Card */
        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .analysis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .analysis-card-header h4 {
            color: #0A4D68;
            margin: 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        /* Auth Styles */
        .auth-container {
            max-width: 500px;
            margin: 3rem auto;
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .auth-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .auth-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #0A4D68;
            border-bottom-color: #0A4D68;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form-group {
            margin-bottom: 1.25rem;
        }

        .auth-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .auth-form-group input,
        .auth-form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .auth-form-group input:focus,
        .auth-form-group select:focus {
            outline: none;
            border-color: #0A4D68;
        }

        .auth-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-success {
            background: #d1fae5;
            color: #065f46;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .logout-btn {
            margin-left: auto;
            padding: 0.5rem 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Profile Styles */
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .profile-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #0A4D68, #088395);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .profile-icon svg {
            width: 32px;
            height: 32px;
        }

        .profile-header h3 {
            margin: 0;
            color: #0A4D68;
            font-size: 1.5rem;
        }

        .profile-details {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .profile-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-value {
            color: #1f2937;
            font-size: 1.1rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 600px;
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Harbor</h1>
        <p class="subtitle">The operating system for small businesses in Santa Cruz</p>

        <!-- Auth Container (shown when not logged in) -->
        <div id="auth-container" class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthForm('login')">Login</button>
                <button class="auth-tab" onclick="showAuthForm('signup')">Sign Up</button>
            </div>

            <div id="auth-error" class="auth-error"></div>
            <div id="auth-success" class="auth-success"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form active" onsubmit="handleLogin(event); return false;">
                <div class="auth-form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="auth-form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
                <div class="auth-form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="auth-form-group">
                    <label for="signup-business-name">Business Name</label>
                    <input type="text" id="signup-business-name" required>
                </div>
                <div class="auth-form-group">
                    <label for="signup-address">Address</label>
                    <input type="text" id="signup-address" required>
                </div>
                <div class="auth-form-group">
                    <label for="signup-business-type">Business Type</label>
                    <select id="signup-business-type" required>
                        <option value="">Select a type</option>
                        <option value="cafe">Cafe</option>
                        <option value="boutique">Boutique</option>
                        <option value="bakery/dessert">Bakery/Dessert</option>
                        <option value="bookstore/stationary">Bookstore/Stationary</option>
                        <option value="art">Art</option>
                    </select>
                </div>
                <div class="auth-form-group">
                    <label for="signup-password">Password (min 8 characters)</label>
                    <input type="password" id="signup-password" minlength="8" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign Up</button>
            </form>
        </div>

        <!-- Main App (shown when logged in) -->
        <div id="main-app" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button" data-tab="touristpulse" style="display: none;">
                    <span class="tab-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                        </svg>
                    </span>
                    TouristPulse
                </button>
                <button class="tab-button" data-tab="cashflow" style="display: none;">
                    <span class="tab-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-3h6m-6 0h6" />
                        </svg>
                    </span>
                    CashFlow Calm
                </button>
                <button class="tab-button" data-tab="rentguard" style="display: none;">
                    <span class="tab-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                        </svg>
                    </span>
                    RentGuard
                </button>
                <button class="tab-button active" data-tab="shopline">
                    <span class="tab-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                    </span>
                    Shopline
                </button>
                <button class="tab-button" data-tab="profile" style="display: none;">
                    <span class="tab-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                    </span>
                    Profile
                </button>
                <button class="logout-btn" onclick="handleLogout()" style="display: none;">Logout</button>
            </div>

        <!-- TouristPulse Tab -->
        <div id="touristpulse" class="tab-content">
            <div class="section-header">
                <div class="forecast-header">
                    <h2 class="forecast-title">7-Day Tourism Forecast</h2>
                    <div class="forecast-location">
                        <svg class="location-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                        </svg>
                        <span>Santa Cruz, California</span>
                    </div>
                </div>
                <button class="refresh-btn" onclick="loadTouristOutlook()" id="refresh-tourist-btn">Refresh</button>
            </div>
            <div id="tourist-loading" class="loading">Loading tourism predictions</div>
            <div id="tourist-error" class="error" style="display: none;"></div>
            <div id="tourist-outlook" class="outlook-grid" style="display: none;"></div>
        </div>

        <!-- CashFlow Calm Tab -->
        <div id="cashflow" class="tab-content">
            <div class="section-header">
                <div class="forecast-header">
                    <h2 class="forecast-title">CashFlow Calm</h2>
                    <div class="forecast-location">
                        <span>Financial Early Warning</span>
                    </div>
                </div>
            </div>

            <div class="module-container">
                <!-- Left: Form -->
                <div class="form-panel">
                    <h3>Upload POS Data</h3>

                    <form id="cashflow-form">
                        <div class="form-group">
                            <label for="csv-file">POS CSV File</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="csv-file" accept=".csv" required>
                                <div class="file-input-label" id="file-label">
                                    <span>Click or drag to upload CSV</span>
                                </div>
                            </div>
                            <small>CSV with date and amount columns</small>
                        </div>

                        <div class="form-group">
                            <label for="business-name">Business Name (Optional)</label>
                            <input type="text" id="business-name" placeholder="e.g., Cafe Luna">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="monthly-rent">Monthly Rent ($) *</label>
                                <input type="number" id="monthly-rent" placeholder="e.g., 4500" step="1" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="monthly-payroll">Monthly Payroll ($)</label>
                                <input type="number" id="monthly-payroll" placeholder="e.g., 8000" step="1" min="0" value="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="other-costs">Other Fixed Costs ($)</label>
                                <input type="number" id="other-costs" placeholder="e.g., 1500" step="1" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="cash-on-hand">Cash on Hand ($)</label>
                                <input type="number" id="cash-on-hand" placeholder="e.g., 25000" step="1" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="variable-cost-rate">Variable Cost Rate</label>
                            <input type="number" id="variable-cost-rate" placeholder="e.g., 0.35" step="0.01" min="0" max="1" value="0">
                            <small>COGS/fees as fraction of revenue (0-1)</small>
                        </div>

                        <button type="submit" class="btn btn-primary" id="analyze-btn">
                            Analyze Cash Flow
                        </button>
                    </form>
                </div>

                <!-- Right: Results -->
                <div class="results-panel">
                    <h3>Analysis Results</h3>

                    <div id="cashflow-empty" class="results-empty">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <p>Upload your POS data to get cash flow analysis and runway projections.</p>
                    </div>

                    <div id="cashflow-loading" class="loading" style="display: none;">Analyzing your data</div>
                    <div id="cashflow-error" class="error" style="display: none;"></div>
                    <div id="cashflow-results" style="display: none;"></div>

                    <!-- Previous Analyses -->
                    <div id="cashflow-history" class="history-section" style="display: none;">
                        <h4>Previous Analyses</h4>
                        <div id="analyses-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RentGuard Tab -->
        <div id="rentguard" class="tab-content">
            <div class="section-header">
                <div class="forecast-header">
                    <h2 class="forecast-title">RentGuard</h2>
                    <div class="forecast-location">
                        <span>Rent Impact Simulator</span>
                    </div>
                </div>
            </div>

            <div class="module-container">
                <!-- Left: Form -->
                <div class="form-panel">
                    <h3>Simulate Rent Increase</h3>

                    <div id="rentguard-warning" class="warning-message" style="display: none;">
                        <strong>No analyses found!</strong>
                        <p style="margin-top: 0.5rem;">You need to create a CashFlow analysis first before simulating rent impacts.</p>
                        <p style="margin-top: 0.5rem;"><a href="#" onclick="showTab('cashflow'); return false;">Go to CashFlow Calm</a></p>
                    </div>

                    <form id="rentguard-form" style="display: none;">
                        <div class="form-group">
                            <label for="analysis-select">Select Analysis</label>
                            <select id="analysis-select" required>
                                <option value="">Loading analyses...</option>
                            </select>
                            <small>Choose a CashFlow analysis to simulate rent changes</small>
                        </div>

                        <div class="form-group">
                            <label for="increase-pct">Rent Increase (%)</label>
                            <input type="number" id="increase-pct" placeholder="e.g., 15" step="0.1" min="0" max="200">
                            <small>Enter the percentage your rent will increase</small>
                        </div>

                        <div class="form-divider">- OR -</div>

                        <div class="form-group">
                            <label for="new-rent">New Monthly Rent ($)</label>
                            <input type="number" id="new-rent" placeholder="e.g., 5500" step="1" min="1">
                            <small>Enter the new absolute rent amount</small>
                        </div>

                        <div class="form-group">
                            <label for="effective-date">Effective Date (Optional)</label>
                            <input type="date" id="effective-date">
                            <small>When does the new rent take effect?</small>
                        </div>

                        <button type="submit" class="btn btn-primary" id="simulate-btn">
                            Simulate Impact
                        </button>
                    </form>
                </div>

                <!-- Right: Results -->
                <div class="results-panel">
                    <h3>Impact Analysis</h3>

                    <div id="rentguard-empty" class="results-empty">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        <p>Select an analysis and enter a rent increase to see the impact on your business.</p>
                    </div>

                    <div id="rentguard-loading" class="loading" style="display: none;">Calculating impact</div>
                    <div id="rentguard-error" class="error" style="display: none;"></div>
                    <div id="rentguard-results" style="display: none;"></div>

                    <div id="scenarios-history" class="history-section" style="display: none;">
                        <h4>Previous Scenarios</h4>
                        <div id="scenarios-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shopline Tab -->
        <div id="shopline" class="tab-content">
            <div class="section-header">
                <div class="forecast-header">
                    <h2 class="forecast-title">Shopline</h2>
                    <div class="forecast-location">
                        <span>Local Business Discovery</span>
                    </div>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="shopline-query" placeholder="Search for local businesses (e.g., coffee shops, bookstores)">
                <button onclick="searchBusinesses()" id="search-btn">Search</button>
            </div>

            <div id="shopline-loading" class="loading" style="display: none;">Searching local businesses</div>
            <div id="shopline-error" class="error" style="display: none;"></div>

            <div id="shopline-results" style="display: none;">
                <h3 style="margin-bottom: 1rem;">Search Results</h3>
                <div id="search-results" class="business-grid"></div>
            </div>

            <div id="featured-section" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Featured Local Businesses</h3>
                <div id="featured-loading" class="loading">Loading featured businesses</div>
                <div id="featured-results" class="business-grid" style="display: none;"></div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="section-header">
                <div class="forecast-header">
                    <h2 class="forecast-title">Profile</h2>
                </div>
            </div>

            <div id="profile-loading" class="loading">Loading profile information</div>
            <div id="profile-error" class="error" style="display: none;"></div>
            <div id="profile-content" style="display: none;">
                <div class="profile-section">
                    <div class="profile-field">
                        <div class="profile-label">Business Name</div>
                        <div class="profile-value" id="profile-business-name">N/A</div>
                    </div>
                    <div class="profile-field">
                        <div class="profile-label">Email</div>
                        <div class="profile-value" id="profile-email">N/A</div>
                    </div>
                    <div class="profile-field">
                        <div class="profile-label">Address</div>
                        <div class="profile-value" id="profile-address">N/A</div>
                    </div>
                    <div class="profile-field">
                        <div class="profile-label">Business Type</div>
                        <div class="profile-value" id="profile-business-type">N/A</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend URL - change to localhost:8000 for local development
        const BACKEND_URL = 'https://harborproject-cruzhacks26.onrender.com';
        const LOCATION = 'Santa Cruz';

        // ===== Auth State Management =====
        function getAuthToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('auth_token');
        }

        function setAuthToken(token) {
            localStorage.setItem('access_token', token);
            localStorage.setItem('auth_token', token); // Keep both for compatibility
        }

        function removeAuthToken() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('auth_token');
        }

        function isAuthenticated() {
            return !!getAuthToken();
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            if (!token) return {};
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // Initialize login form when DOM is ready
        function initLoginForm() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                // Remove any existing listeners
                const newForm = loginForm.cloneNode(true);
                loginForm.parentNode.replaceChild(newForm, loginForm);
                
                // Add submit listener
                newForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('Form submit event triggered');
                    handleLogin(e);
                });
                
                // Also add click listener to button as backup
                const loginBtn = newForm.querySelector('button[type="submit"]');
                if (loginBtn) {
                    loginBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Login button clicked');
                        handleLogin(e);
                    });
                }
                console.log('Login form initialized');
            } else {
                console.error('Login form not found during initialization');
            }
        }

        // Check auth on page load
        function checkAuth() {
            if (isAuthenticated()) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                // Show all tabs for authenticated users
                document.querySelectorAll('.tab-button[data-tab="touristpulse"]').forEach(btn => btn.style.display = '');
                document.querySelectorAll('.tab-button[data-tab="cashflow"]').forEach(btn => btn.style.display = '');
                document.querySelectorAll('.tab-button[data-tab="rentguard"]').forEach(btn => btn.style.display = '');
                document.querySelectorAll('.tab-button[data-tab="profile"]').forEach(btn => btn.style.display = '');
                document.querySelectorAll('.logout-btn').forEach(btn => btn.style.display = '');
            } else {
                document.getElementById('auth-container').style.display = 'block';
                document.getElementById('main-app').style.display = 'block'; // Show main app but only Shopline tab
                // Hide protected tabs, show only Shopline
                document.querySelectorAll('.tab-button[data-tab="touristpulse"]').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('.tab-button[data-tab="cashflow"]').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('.tab-button[data-tab="rentguard"]').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('.tab-button[data-tab="profile"]').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('.logout-btn').forEach(btn => btn.style.display = 'none');
                showTab('shopline');
            }
        }

        // Auth form switching
        function showAuthForm(formType) {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            
            if (formType === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('signup-form').classList.add('active');
            }
            
            document.getElementById('auth-error').style.display = 'none';
            document.getElementById('auth-success').style.display = 'none';
        }

        // Handle login
        async function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            console.log('handleLogin called');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('auth-error');
            const successEl = document.getElementById('auth-success');

            if (!email || !password) {
                errorEl.textContent = 'Please enter both email and password';
                errorEl.style.display = 'block';
                return;
            }

            // Clear previous messages
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            try {
                const response = await fetch(`${BACKEND_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    let errorMessage = 'Login failed';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || error.message || `HTTP ${response.status}: ${response.statusText}`;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (!data.access_token) {
                    throw new Error('No access token received from server');
                }
                
                setAuthToken(data.access_token);
                successEl.textContent = 'Login successful!';
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
                
                setTimeout(() => {
                    checkAuth();
                }, 500);
            } catch (err) {
                console.error('Login error:', err);
                // Handle network errors specifically
                if (err.name === 'TypeError' && err.message.includes('fetch')) {
                    errorEl.textContent = 'Network error: Could not connect to server. Please check your connection and try again.';
                } else if (err.message) {
                    errorEl.textContent = err.message;
                } else {
                    errorEl.textContent = 'Login failed. Please try again.';
                }
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            }
        }

        // Handle signup
        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const businessName = document.getElementById('signup-business-name').value;
            const address = document.getElementById('signup-address').value;
            const businessType = document.getElementById('signup-business-type').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('auth-error');
            const successEl = document.getElementById('auth-success');

            try {
                const response = await fetch(`${BACKEND_URL}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        business_name: businessName,
                        address,
                        business_type: businessType,
                        password
                    })
                });

                // Check if response is ok (status 200-299)
                if (response.ok) {
                    // Parse response to ensure it's valid JSON
                    try {
                        const data = await response.json();
                        console.log('Signup successful:', data);
                    } catch (e) {
                        // If response is empty or not JSON, that's still OK for 201 Created
                        console.log('Signup successful (no response body)');
                    }

                    successEl.textContent = 'Account created! Please login.';
                    successEl.style.display = 'block';
                    errorEl.style.display = 'none';
                    
                    // Switch to login form
                    setTimeout(() => {
                        showAuthForm('login');
                        document.getElementById('login-email').value = email;
                    }, 1000);
                } else {
                    // Handle error response
                    let errorMessage = 'Signup failed';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || error.message || `HTTP ${response.status}: ${response.statusText}`;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (err) {
                console.error('Signup error:', err);
                // Check if it's a network error
                if (err.message === 'Failed to fetch' || err.name === 'TypeError') {
                    errorEl.textContent = 'Network error. The account may have been created. Please try logging in.';
                } else {
                    errorEl.textContent = err.message || 'Signup failed. Please try again.';
                }
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            }
        }

        // Handle logout
        function handleLogout() {
            removeAuthToken();
            checkAuth();
        }

        // Initialize auth check on page load
        checkAuth();

        // ===== Tab Switching =====
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                // Check if user is trying to access protected tab
                if (!isAuthenticated() && ['touristpulse', 'cashflow', 'rentguard'].includes(tabName)) {
                    alert('Please login to access this feature');
                    return;
                }
                showTab(tabName);
            });
        });

        // Ensure login form submission works
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
        }

        function showTab(tabName) {
            // Prevent access to protected tabs if not authenticated
            if (!isAuthenticated() && ['touristpulse', 'cashflow', 'rentguard', 'profile'].includes(tabName)) {
                return;
            }

            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            const tabElement = document.getElementById(tabName);
            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);

            if (tabElement && tabButton) {
                tabElement.classList.add('active');
                tabButton.classList.add('active');
            }

            // Load data when switching to certain tabs
            if (tabName === 'rentguard') {
                loadAnalysesForRentGuard();
            } else if (tabName === 'cashflow') {
                loadPreviousAnalyses();
            } else if (tabName === 'shopline') {
                loadFeaturedBusinesses();
            } else if (tabName === 'touristpulse') {
                loadTouristOutlook();
            } else if (tabName === 'profile') {
                loadProfile();
            }
        }

        // ===== Utility Functions =====
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return 'N/A';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return 'N/A';
            return `${(value * 100).toFixed(1)}%`;
        }

        function formatDate(dateString) {
            // Handle both date strings and date objects
            let date;
            if (typeof dateString === 'string') {
                // If it's just a date string (YYYY-MM-DD), parse it in local timezone
                // to avoid timezone conversion issues
                const [year, month, day] = dateString.split('-').map(Number);
                date = new Date(year, month - 1, day);
            } else {
                date = new Date(dateString);
            }
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateWithDay(dateString) {
            // Handle both date strings and date objects
            let date;
            if (typeof dateString === 'string') {
                const [year, month, day] = dateString.split('-').map(Number);
                date = new Date(year, month - 1, day);
            } else {
                date = new Date(dateString);
            }
            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
            const dateStr = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            return { dayName, dateStr };
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===== Weather Icon Helper =====
        function getWeatherIcon(weatherText) {
            const text = weatherText.toLowerCase();
            // Check for cloudy/partly cloudy/fog conditions
            if (text.includes('cloud') || text.includes('fog') || text.includes('overcast') || text.includes('partly') || text.includes('patchy')) {
                // Sun with cloud (partly cloudy)
                return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15a4.5 4.5 0 004.5 4.5H18a3.75 3.75 0 001.332-7.257 3 3 0 00-3.758-3.848 5.25 5.25 0 00-10.233 2.33A4.502 4.502 0 002.25 15z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>`;
            } else {
                // Simple sun (sunny/clear)
                return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <circle cx="12" cy="12" r="4" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" />
                </svg>`;
            }
        }

        // ===== Profile Functions =====
        async function loadProfile() {
            const loadingEl = document.getElementById('profile-loading');
            const errorEl = document.getElementById('profile-error');
            const contentEl = document.getElementById('profile-content');

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                contentEl.style.display = 'none';

                const response = await fetch(`${BACKEND_URL}/auth/me`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired or invalid
                        removeAuthToken();
                        checkAuth();
                        throw new Error('Session expired. Please login again.');
                    }
                    let errorMessage = 'Failed to load profile';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || error.message || `HTTP ${response.status}: ${response.statusText}`;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Profile data received:', data);
                
                // Update profile fields
                if (!data.business_name || !data.email) {
                    throw new Error('Invalid profile data received from server');
                }
                
                document.getElementById('profile-business-name').textContent = data.business_name || 'N/A';
                document.getElementById('profile-email').textContent = data.email || 'N/A';
                document.getElementById('profile-address').textContent = data.address || 'N/A';
                document.getElementById('profile-business-type').textContent = data.business_type || 'N/A';

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (err) {
                console.error('Profile loading error:', err);
                loadingEl.style.display = 'none';
                errorEl.textContent = err.message || 'Failed to load profile information';
                errorEl.style.display = 'block';
            }
        }

        // ===== TouristPulse Functions =====
        function getLevelLabel(level) {
            const labels = {
                'low': 'LOW',
                'moderate': 'NORMAL',
                'high': 'HIGH',
                'very_high': 'VERY HIGH'
            };
            return labels[level] || level.toUpperCase();
        }

        function getLevelClass(level) {
            return level === 'very_high' ? 'very_high' : level;
        }

        async function loadTouristOutlook() {
            const loadingEl = document.getElementById('tourist-loading');
            const errorEl = document.getElementById('tourist-error');
            const outlookEl = document.getElementById('tourist-outlook');
            const refreshBtn = document.getElementById('refresh-tourist-btn');

            try {
                refreshBtn.disabled = true;
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                outlookEl.style.display = 'none';

                const response = await fetch(
                    `${BACKEND_URL}/touristpulse/outlook?location=${encodeURIComponent(LOCATION)}&days=7`,
                    {
                        headers: getAuthHeaders()
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.outlook || data.outlook.length === 0) {
                    throw new Error('No outlook data received');
                }

                displayTouristOutlook(data.outlook);

            } catch (err) {
                console.error('Error loading tourist outlook:', err);
                errorEl.innerHTML = `
                    <strong>Error:</strong> ${err.message}
                    <code>Make sure the backend is running at ${BACKEND_URL}</code>
                `;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
                refreshBtn.disabled = false;
            }
        }

        function displayTouristOutlook(outlook) {
            const outlookEl = document.getElementById('tourist-outlook');
            outlookEl.innerHTML = '';

            if (outlook.length === 0) {
                outlookEl.innerHTML = '<div class="empty-state">No outlook data available</div>';
                outlookEl.style.display = 'block';
                return;
            }

            outlook.forEach(day => {
                const card = document.createElement('div');
                card.className = 'outlook-card';

                // Extract key information from drivers
                let weatherText = '';
                let eventsText = '';
                let trafficText = '';
                
                if (day.drivers && Array.isArray(day.drivers)) {
                    day.drivers.forEach(driver => {
                        if (driver.source === 'weather' && driver.factor) {
                            // Capitalize first letter of each word
                            weatherText = driver.factor.split(' ').map(w => 
                                w.charAt(0).toUpperCase() + w.slice(1)
                            ).join(' ');
                        } else if (driver.source === 'events' && driver.factor) {
                            // Parse "6 event(s)" format or just use the text
                            const eventMatch = driver.factor.match(/(\d+)\s*event/i);
                            if (eventMatch) {
                                const count = parseInt(eventMatch[1]);
                                eventsText = count === 1 ? '1 event' : `${count} events`;
                            } else {
                                eventsText = driver.factor;
                            }
                        } else if (driver.source === 'traffic' && driver.factor) {
                            trafficText = driver.factor;
                        }
                    });
                }

                // If no drivers parsed, try to extract from summary
                if (!weatherText && day.summary) {
                    const weatherMatch = day.summary.match(/(sunny|cloudy|rainy|clear|mostly sunny|partly cloudy|overcast)/i);
                    if (weatherMatch) {
                        weatherText = weatherMatch[1].charAt(0).toUpperCase() + weatherMatch[1].slice(1);
                    }
                }

                // Extract traffic level from summary if not found
                if (!trafficText || trafficText === 'congestion') {
                    if (day.summary) {
                        const summaryLower = day.summary.toLowerCase();
                        if (summaryLower.includes('high congestion') || summaryLower.includes('heavy traffic')) {
                            trafficText = 'High congestion';
                        } else if (summaryLower.includes('moderate congestion') || summaryLower.includes('moderate traffic')) {
                            trafficText = 'Moderate congestion';
                        } else if (summaryLower.includes('low congestion') || summaryLower.includes('light traffic')) {
                            trafficText = 'Low congestion';
                        } else {
                            trafficText = 'Moderate congestion';
                        }
                    } else {
                        trafficText = 'Moderate congestion';
                    }
                } else {
                    // Capitalize traffic text
                    trafficText = trafficText.charAt(0).toUpperCase() + trafficText.slice(1);
                }

                // Format weather text
                if (!weatherText) weatherText = 'Weather data unavailable';

                // Get activity level label
                const activityLabel = day.demand_level === 'high' ? 'High Activity' : 
                                    day.demand_level === 'moderate' ? 'Moderate Activity' : 
                                    'Low Activity';
                const activityClass = day.demand_level === 'high' ? 'high' : 
                                     day.demand_level === 'moderate' ? 'moderate' : 
                                     'low';
                const confidencePercent = day.confidence ? Math.round(day.confidence * 100) : 0;
                const { dayName, dateStr } = formatDateWithDay(day.date);

                // Activity icon SVG
                const activityIcon = activityClass === 'high' 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>`
                    : activityClass === 'moderate'
                    ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>`;

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-date-container">
                            <div class="card-day">${dayName}</div>
                            <div class="card-date">${dateStr}</div>
                        </div>
                        <div class="activity-badge-container">
                            <div class="activity-badge ${activityClass}">
                                <div class="activity-icon">${activityIcon}</div>
                                ${activityLabel}
                            </div>
                            <div class="activity-progress-container">
                                <div class="activity-progress-bar">
                                    <div class="activity-progress-fill" style="width: ${confidencePercent}%"></div>
                                </div>
                                <span class="activity-percentage">${confidencePercent}%</span>
                            </div>
                        </div>
                    </div>
                    ${day.summary ? `<div class="card-summary">${day.summary}</div>` : ''}
                    <div class="key-drivers">
                        <div class="key-drivers-title">KEY DRIVERS</div>
                        ${weatherText ? `
                            <div class="driver-item">
                                <div class="driver-icon">
                                    ${getWeatherIcon(weatherText)}
                                </div>
                                <span>${weatherText}</span>
                            </div>
                        ` : ''}
                        ${eventsText ? `
                            <div class="driver-item">
                                <div class="driver-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                    </svg>
                                </div>
                                <span>${eventsText}</span>
                            </div>
                        ` : ''}
                        ${trafficText ? `
                            <div class="driver-item">
                                <div class="driver-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V11.25c0-1.621-1.505-2.125-3-2.125m0 12.375h-1.5c-.621 0-1.125.504-1.125 1.125v3.375c0 .621.504 1.125 1.125 1.125h1.5c.621 0 1.125-.504 1.125-1.125v-3.375c0-.621-.504-1.125-1.125-1.125m8.25-9.75H21m-1.5 0v-1.5m0 1.5v-1.5m-1.5 0h1.5m-1.5 0h-1.5m0 0H12m-1.5 0H9.75m0 0H8.25m1.5 0v1.5m0-1.5v1.5m0 0h1.5m-1.5 0h1.5" />
                                    </svg>
                                </div>
                                <span>${trafficText}</span>
                            </div>
                        ` : ''}
                    </div>
                `;

                outlookEl.appendChild(card);
            });

            outlookEl.style.display = 'grid';
        }

        // ===== CashFlow Functions =====
        const csvFileInput = document.getElementById('csv-file');
        const fileLabel = document.getElementById('file-label');

        csvFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileLabel.innerHTML = `<span>${e.target.files[0].name}</span>`;
                fileLabel.classList.add('has-file');
            } else {
                fileLabel.innerHTML = '<span>Click or drag to upload CSV</span>';
                fileLabel.classList.remove('has-file');
            }
        });

        document.getElementById('cashflow-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await analyzeCashFlow();
        });

        async function analyzeCashFlow() {
            const emptyEl = document.getElementById('cashflow-empty');
            const loadingEl = document.getElementById('cashflow-loading');
            const errorEl = document.getElementById('cashflow-error');
            const resultsEl = document.getElementById('cashflow-results');
            const analyzeBtn = document.getElementById('analyze-btn');

            const csvFile = document.getElementById('csv-file').files[0];
            const rent = document.getElementById('monthly-rent').value;
            const payroll = document.getElementById('monthly-payroll').value || 0;
            const other = document.getElementById('other-costs').value || 0;
            const cashOnHand = document.getElementById('cash-on-hand').value;
            const variableCostRate = document.getElementById('variable-cost-rate').value || 0;
            const businessName = document.getElementById('business-name').value;

            if (!csvFile) {
                errorEl.innerHTML = '<strong>Error:</strong> Please select a CSV file';
                errorEl.style.display = 'block';
                return;
            }

            try {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing...';
                emptyEl.style.display = 'none';
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                resultsEl.style.display = 'none';

                const formData = new FormData();
                formData.append('csv_file', csvFile);
                formData.append('rent', rent);
                formData.append('payroll', payroll);
                formData.append('other', other);
                formData.append('variable_cost_rate', variableCostRate);
                if (cashOnHand) formData.append('cash_on_hand', cashOnHand);
                if (businessName) formData.append('business_name', businessName);

                // FormData: Don't set Content-Type, browser sets it with boundary
                const token = getAuthToken();
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${BACKEND_URL}/cashflow/analyze`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API error: ${response.status}`);
                }

                const data = await response.json();
                displayCashFlowResults(data);
                loadPreviousAnalyses();

            } catch (err) {
                console.error('Error analyzing cash flow:', err);
                errorEl.innerHTML = `<strong>Error:</strong> ${err.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Cash Flow';
            }
        }

        function displayCashFlowResults(data) {
            const resultsEl = document.getElementById('cashflow-results');
            const metrics = data.metrics;
            const explanation = data.explanation;

            const runwayText = metrics.runway_days === null || metrics.runway_days > 365
                ? 'Indefinite'
                : `${Math.round(metrics.runway_days)} days`;

            resultsEl.innerHTML = `
                <div class="analysis-card">
                    <div class="analysis-card-header">
                        <h4>${data.business_name || 'Analysis'} #${data.analysis_id}</h4>
                        <span class="risk-badge ${metrics.risk_state}">${metrics.risk_state}</span>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(metrics.avg_daily_revenue)}</div>
                            <div class="metric-label">Avg Daily Revenue</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${runwayText}</div>
                            <div class="metric-label">Cash Runway</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value ${metrics.trend_7d >= 0 ? 'positive' : 'negative'}">${metrics.trend_7d.toFixed(1)}%</div>
                            <div class="metric-label">7-Day Trend</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatPercent(metrics.fixed_cost_burden)}</div>
                            <div class="metric-label">Fixed Cost Burden</div>
                        </div>
                    </div>

                    <div class="explanation-section">
                        <h5>Key Insights</h5>
                        <ul class="bullets-list">
                            ${explanation.bullets.map(b => `<li>${b}</li>`).join('')}
                        </ul>

                        ${explanation.actions && explanation.actions.length > 0 ? `
                            <h5 style="margin-top: 1rem;">Recommended Actions</h5>
                            <ul class="recommendations-list">
                                ${explanation.actions.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        ` : ''}

                        <p style="margin-top: 1rem; font-size: 0.85rem; color: #6b7280;">
                            <em>${explanation.confidence_note}</em>
                        </p>
                    </div>
                </div>
            `;
            resultsEl.style.display = 'block';
        }

        async function loadPreviousAnalyses() {
            const historySection = document.getElementById('cashflow-history');
            const analysesList = document.getElementById('analyses-list');

            try {
                const response = await fetch(`${BACKEND_URL}/cashflow/analyses?limit=5`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) return;

                const analyses = await response.json();

                if (analyses.length === 0) {
                    historySection.style.display = 'none';
                    return;
                }

                analysesList.innerHTML = analyses.map(a => `
                    <div class="history-item" onclick="loadAnalysisDetails(${a.id})">
                        <span>${a.business_name || 'Analysis'} #${a.id}</span>
                        <span>
                            <span class="risk-badge ${a.risk_state}">${a.risk_state}</span>
                            <span class="date">${formatDateTime(a.created_at)}</span>
                        </span>
                    </div>
                `).join('');

                historySection.style.display = 'block';
            } catch (err) {
                console.error('Error loading analyses:', err);
            }
        }

        async function loadAnalysisDetails(analysisId) {
            try {
                const response = await fetch(`${BACKEND_URL}/cashflow/analyses/${analysisId}`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Failed to load analysis');

                const data = await response.json();

                // Convert to display format
                const displayData = {
                    analysis_id: data.analysis_id,
                    business_name: data.business_name,
                    metrics: data.metrics,
                    explanation: {
                        bullets: [
                            `Analysis based on ${data.data_days} days of data`,
                            `Fixed costs: Rent ${formatCurrency(data.fixed_costs?.rent)}, Payroll ${formatCurrency(data.fixed_costs?.payroll)}`,
                            data.fixed_costs?.cash_on_hand ? `Cash reserves: ${formatCurrency(data.fixed_costs.cash_on_hand)}` : 'No cash reserves recorded'
                        ],
                        actions: [],
                        confidence_note: `Confidence: ${(data.metrics.confidence * 100).toFixed(0)}%`
                    }
                };

                displayCashFlowResults(displayData);
            } catch (err) {
                console.error('Error loading analysis details:', err);
            }
        }

        // ===== RentGuard Functions =====
        async function loadAnalysesForRentGuard() {
            const warningEl = document.getElementById('rentguard-warning');
            const formEl = document.getElementById('rentguard-form');
            const selectEl = document.getElementById('analysis-select');

            try {
                const response = await fetch(`${BACKEND_URL}/cashflow/analyses?limit=20`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Failed to load analyses');

                const analyses = await response.json();

                if (analyses.length === 0) {
                    warningEl.style.display = 'block';
                    formEl.style.display = 'none';
                    return;
                }

                warningEl.style.display = 'none';
                formEl.style.display = 'block';

                selectEl.innerHTML = analyses.map(a =>
                    `<option value="${a.id}">${a.business_name || 'Analysis'} #${a.id} (${a.risk_state})</option>`
                ).join('');

                // Load scenarios for first analysis
                loadScenarios(analyses[0].id);

            } catch (err) {
                console.error('Error loading analyses for RentGuard:', err);
                warningEl.innerHTML = `<strong>Error:</strong> ${err.message}`;
                warningEl.style.display = 'block';
                formEl.style.display = 'none';
            }
        }

        document.getElementById('analysis-select').addEventListener('change', (e) => {
            if (e.target.value) {
                loadScenarios(e.target.value);
            }
        });

        document.getElementById('rentguard-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await simulateRentImpact();
        });

        async function simulateRentImpact() {
            const emptyEl = document.getElementById('rentguard-empty');
            const loadingEl = document.getElementById('rentguard-loading');
            const errorEl = document.getElementById('rentguard-error');
            const resultsEl = document.getElementById('rentguard-results');
            const simulateBtn = document.getElementById('simulate-btn');

            const analysisId = document.getElementById('analysis-select').value;
            const increasePct = document.getElementById('increase-pct').value;
            const newRent = document.getElementById('new-rent').value;
            const effectiveDate = document.getElementById('effective-date').value;

            if (!increasePct && !newRent) {
                errorEl.innerHTML = '<strong>Error:</strong> Please enter either a percentage increase or a new rent amount';
                errorEl.style.display = 'block';
                return;
            }

            try {
                simulateBtn.disabled = true;
                simulateBtn.textContent = 'Simulating...';
                emptyEl.style.display = 'none';
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                resultsEl.style.display = 'none';

                const payload = {
                    analysis_id: parseInt(analysisId)
                };
                if (increasePct) payload.increase_pct = parseFloat(increasePct);
                if (newRent) payload.new_rent = parseFloat(newRent);
                if (effectiveDate) payload.effective_date = effectiveDate;

                const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
                const response = await fetch(`${BACKEND_URL}/rentguard/impact`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API error: ${response.status}`);
                }

                const data = await response.json();
                displayRentImpactResults(data);
                loadScenarios(analysisId);

            } catch (err) {
                console.error('Error simulating rent impact:', err);
                errorEl.innerHTML = `<strong>Error:</strong> ${err.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
                simulateBtn.disabled = false;
                simulateBtn.textContent = 'Simulate Impact';
            }
        }

        function displayRentImpactResults(data) {
            const resultsEl = document.getElementById('rentguard-results');
            const metrics = data.metrics;
            const explanation = data.explanation;

            const deltaClass = metrics.delta_monthly > 0 ? 'negative' : 'positive';
            const runwayImpactText = metrics.runway_impact_days === null
                ? 'N/A'
                : (metrics.runway_impact_days > 0 ? '+' : '') + Math.round(metrics.runway_impact_days) + ' days';

            resultsEl.innerHTML = `
                <div class="impact-card">
                    <div class="impact-header">
                        <h4>Rent Impact Analysis</h4>
                    </div>
                    <div class="impact-body">
                        <div class="impact-metrics">
                            <div class="metric-item">
                                <div class="metric-value">${formatCurrency(metrics.current_rent)}</div>
                                <div class="metric-label">Current Rent</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${formatCurrency(metrics.new_rent)}</div>
                                <div class="metric-label">New Rent</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value ${deltaClass}">${metrics.delta_monthly > 0 ? '+' : ''}${formatCurrency(metrics.delta_monthly)}</div>
                                <div class="metric-label">Monthly Change</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value ${deltaClass}">${metrics.delta_pct > 0 ? '+' : ''}${metrics.delta_pct.toFixed(1)}%</div>
                                <div class="metric-label">Percentage Change</div>
                            </div>
                        </div>

                        <div class="risk-transition">
                            <span class="risk-badge ${metrics.current_risk_state}">${metrics.current_risk_state}</span>
                            <span class="risk-arrow"></span>
                            <span class="risk-badge ${metrics.new_risk_state}">${metrics.new_risk_state}</span>
                        </div>

                        <div class="impact-metrics">
                            <div class="metric-item">
                                <div class="metric-value ${metrics.runway_impact_days < 0 ? 'negative' : ''}">${runwayImpactText}</div>
                                <div class="metric-label">Runway Impact</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${metrics.new_fixed_cost_burden ? formatPercent(metrics.new_fixed_cost_burden) : 'N/A'}</div>
                                <div class="metric-label">New Cost Burden</div>
                            </div>
                        </div>

                        <div class="explanation-section">
                            <h5>Summary</h5>
                            <p>${explanation.summary}</p>

                            ${explanation.key_drivers && explanation.key_drivers.length > 0 ? `
                                <h5>Key Concerns</h5>
                                <ul class="concerns-list">
                                    ${explanation.key_drivers.map(d => `<li>${d}</li>`).join('')}
                                </ul>
                            ` : ''}

                            ${explanation.recommended_actions && explanation.recommended_actions.length > 0 ? `
                                <h5>Recommended Actions</h5>
                                <ul class="recommendations-list">
                                    ${explanation.recommended_actions.map(a => `<li>${a}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            resultsEl.style.display = 'block';
        }

        async function loadScenarios(analysisId) {
            const historySection = document.getElementById('scenarios-history');
            const scenariosList = document.getElementById('scenarios-list');

            try {
                const response = await fetch(`${BACKEND_URL}/rentguard/scenarios/${analysisId}`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) return;

                const scenarios = await response.json();

                if (scenarios.length === 0) {
                    historySection.style.display = 'none';
                    return;
                }

                scenariosList.innerHTML = scenarios.map(s => `
                    <div class="history-item">
                        <span>${s.increase_pct ? `+${s.increase_pct.toFixed(1)}%` : formatCurrency(s.new_rent)}</span>
                        <span>
                            <span class="risk-badge ${s.new_risk_state}">${s.new_risk_state}</span>
                            <span class="date">${formatDateTime(s.created_at)}</span>
                        </span>
                    </div>
                `).join('');

                historySection.style.display = 'block';
            } catch (err) {
                console.error('Error loading scenarios:', err);
            }
        }

        // ===== Shopline Functions =====
        document.getElementById('shopline-query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchBusinesses();
        });

        async function searchBusinesses() {
            const query = document.getElementById('shopline-query').value.trim();
            if (!query) return;

            const loadingEl = document.getElementById('shopline-loading');
            const errorEl = document.getElementById('shopline-error');
            const resultsSection = document.getElementById('shopline-results');
            const resultsEl = document.getElementById('search-results');
            const searchBtn = document.getElementById('search-btn');

            try {
                searchBtn.disabled = true;
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                resultsSection.style.display = 'none';

                const response = await fetch(`${BACKEND_URL}/shopline/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        location: LOCATION
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API error: ${response.status}`);
                }

                const data = await response.json();
                displaySearchResults(data.results);

            } catch (err) {
                console.error('Error searching businesses:', err);
                errorEl.innerHTML = `<strong>Error:</strong> ${err.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
                searchBtn.disabled = false;
            }
        }

        function displaySearchResults(results) {
            const resultsSection = document.getElementById('shopline-results');
            const resultsEl = document.getElementById('search-results');

            if (results.length === 0) {
                resultsEl.innerHTML = '<div class="empty-state">No businesses found matching your search.</div>';
            } else {
                resultsEl.innerHTML = results.map(b => `
                    <div class="business-card">
                        <h4>${b.name}</h4>
                        <span class="category">${b.category}</span>
                        <div class="location">${b.location}</div>
                        ${b.description ? `<div class="description">${b.description}</div>` : ''}
                    </div>
                `).join('');
            }

            resultsSection.style.display = 'block';
        }

        async function loadFeaturedBusinesses() {
            const loadingEl = document.getElementById('featured-loading');
            const resultsEl = document.getElementById('featured-results');

            // Check if already loaded
            if (resultsEl.innerHTML.trim()) {
                loadingEl.style.display = 'none';
                resultsEl.style.display = 'grid';
                return;
            }

            try {
                loadingEl.style.display = 'block';
                resultsEl.style.display = 'none';

                // First search for some businesses
                const searchResponse = await fetch(`${BACKEND_URL}/shopline/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'local shops restaurants',
                        location: LOCATION
                    })
                });

                if (!searchResponse.ok) throw new Error('Failed to search businesses');

                const searchData = await searchResponse.json();

                if (searchData.results.length === 0) {
                    resultsEl.innerHTML = '<div class="empty-state">No featured businesses available.</div>';
                    resultsEl.style.display = 'block';
                    loadingEl.style.display = 'none';
                    return;
                }

                // Get featured rankings
                const featuredResponse = await fetch(`${BACKEND_URL}/shopline/featured`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        businesses: searchData.results.slice(0, 6),
                        ranking_factors: {
                            local: 0.4,
                            sustainable: 0.3,
                            community: 0.3
                        }
                    })
                });

                if (!featuredResponse.ok) throw new Error('Failed to get featured businesses');

                const featuredData = await featuredResponse.json();
                displayFeaturedBusinesses(featuredData.featured);

            } catch (err) {
                console.error('Error loading featured businesses:', err);
                resultsEl.innerHTML = `<div class="error"><strong>Error:</strong> ${err.message}</div>`;
                resultsEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function displayFeaturedBusinesses(businesses) {
            const resultsEl = document.getElementById('featured-results');

            if (businesses.length === 0) {
                resultsEl.innerHTML = '<div class="empty-state">No featured businesses available.</div>';
            } else {
                resultsEl.innerHTML = businesses.map(b => `
                    <div class="business-card">
                        <h4>${b.name}</h4>
                        <span class="category">${b.category}</span>
                        <div class="location">${b.location}</div>
                        ${b.blurb ? `<div class="description">${b.blurb}</div>` : ''}
                        ${b.highlights && b.highlights.length > 0 ? `
                            <ul class="highlights-list">
                                ${b.highlights.map(h => `<li>${h}</li>`).join('')}
                            </ul>
                        ` : ''}
                        <div class="score">
                            <div class="score-bar">
                                <div class="score-fill" style="width: ${b.score}%"></div>
                            </div>
                            <span class="score-value">${b.score}</span>
                        </div>
                    </div>
                `).join('');
            }

            resultsEl.style.display = 'grid';
        }

        // ===== Initialize =====
        window.addEventListener('DOMContentLoaded', () => {
            loadTouristOutlook();
        });
    </script>
</body>
</html>
